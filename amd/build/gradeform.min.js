/**
 * JavaScript functions to help grade form
 * @copyright 2012 Juan Carlos Rodr√≠guez-del-Pino, 2021 Astor Bizard
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_vpl/gradeform",["jquery"],(function($){function reduceGradeWithComments(grade,comments){for(var match,regDiscount=/^-.+\((-[0-9.]+)\)\s*$/gm;null!==(match=regDiscount.exec(comments));){var rest=parseFloat(match[1]);rest<0&&(grade+=rest)}return grade}function formatGrade(grade){return grade<0?0:Math.round(100*grade)/100}return{setup:function(){$('button[data-role="calculategrade"]').click((function(){var $form=$(this).closest("form"),text=$form.find('[name="comments"]').val(),grade=parseFloat($(this).data("maxgrade"));grade=formatGrade(reduceGradeWithComments(grade,text)),$form.find('[name="grade"]').val(grade)})),$('button[data-role="mergegrade"]').click((function(){var $form=$(this).closest("form"),gridpoints=0;$form.find(".score .scorevalue").length>0?$form.find(".checked .score .scorevalue").each((function(){gridpoints+=Number($(this).text())})):$form.find(".score input").each((function(){gridpoints+=Number($(this).val())}));var advancedgradingcomments="";$form.find(".criterion .remark textarea").each((function(){advancedgradingcomments+=$(this).val()+"\n"})),gridpoints=reduceGradeWithComments(gridpoints,advancedgradingcomments);var maxgrade=$(this).data("maxgrade"),currentgrade=$(this).data("currentgrade"),grade=formatGrade(currentgrade-$(this).data("maxgridpoints")*(currentgrade/maxgrade)+gridpoints);$form.find('[name="grade"]').val(grade);var $comments=$form.find('[name="comments"]'),text=$comments.val(),gridcomment="#Grid grade: "+grade,proposedcomment="#Proposed grade: "+currentgrade;text=(text=text.search("#Grid grade")<0?gridcomment+"\n"+text:text.replace(new RegExp("#Grid grade.*"),gridcomment)).search("#Proposed grade")<0?proposedcomment+"\n"+text:text.replace(new RegExp("#Proposed grade.*"),proposedcomment),$comments.val(text)})),$('button[data-role="importfromsub"]').click((function(){var $form=$(this).closest("form");$form.find('[name="grade"]').val($(this).data("grade")),$form.find('[name="comments"]').val($(this).data("comments")),$("#advancedgrading-criteria .criterion .remark textarea").val(""),$("#advancedgrading-criteria .criterion .score input").val(""),$("#advancedgrading-criteria .criterion .level.checked").click(),$(this).data("advgrading").forEach((function(criterion){var id=criterion.criterionid;void 0!==criterion.remark&&$form.find('[name="advancedgrading[criteria]['+id+'][remark]"]').val(criterion.remark),void 0!==criterion.score&&$form.find('[name="advancedgrading[criteria]['+id+'][score]"]').val(parseFloat(criterion.score)),void 0!==criterion.levelid&&$("#advancedgrading-criteria-"+id+"-levels-"+criterion.levelid).click()}))}))},updateSubmissionsList:function(submissionID,gradeData,nexturl){if(null!==opener&&($(opener.document).find("#g"+submissionID).html(gradeData.grade),$(opener.document).find("#m"+submissionID).html(gradeData.grader),$(opener.document).find("#o"+submissionID).html(gradeData.gradedon),$(opener.document).find("#c"+submissionID).html(gradeData.comments),$(opener.document).find(".gd"+submissionID).css("color","").css("backgroundColor","")),nexturl){null===opener&&window.close();var nextrow=$(opener.document).find("#g"+submissionID).closest("tr").next();0==nextrow.length&&window.close();var nextid=nextrow.html().match(/user\/view\.php\?(.*?)id=([0-9]+)/)[2];nextid?location.replace(nexturl+nextid):window.close()}},highlightSubmission:function(submissionID){null!==opener&&($(opener.document).find(".gd"+submissionID).css("color","black").css("backgroundColor","yellow"),window.onunload=function(){$(opener.document).find(".gd"+submissionID).css("color","").css("backgroundColor","")})}}}));

//# sourceMappingURL=gradeform.min.js.map