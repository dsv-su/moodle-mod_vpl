{"version":3,"file":"evaluationmonitor.min.js","sources":["../src/evaluationmonitor.js"],"sourcesContent":["// This file is part of VPL for Moodle - http://vpl.dis.ulpgc.es/\n//\n// VPL for Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// VPL for Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with VPL for Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Evaluation monitoring\n *\n * @copyright 2013 onward Juan Carlos Rodr√≠guez-del-Pino\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author Juan Carlos Rodr√≠guez-del-Pino <jcrodriguez@dis.ulpgc.es>\n */\n\n/* globals VPL */\n\ndefine(['mod_vpl/vplui'],\nfunction(VPLUI) {\n    /**\n     * Evaluate a submission\n     * @param {*} options {nexturl: url to go next, ajaxurl: url to evaluate}\n     */\n    function init(options) {\n        options.next = function() {\n            window.location = options.nexturl;\n        };\n\n        /**\n         * Show a error message in a modal dialog.\n         * Allows to go next evaluation.\n         *\n         * @param {string} message Message to shohw in dialog.\n         */\n        function showErrorMessage(message) {\n            VPLUI.showErrorMessage(message, {\n                next: options.next\n            });\n        }\n\n        var action;\n        var executionActions = {\n            'ajaxurl': options.ajaxurl,\n            'run': showErrorMessage,\n            'getLastAction': function() {\n                action();\n            },\n        };\n\n        action = function() {\n            VPLUI.requestAction('evaluate', 'evaluating', {}, options.ajaxurl)\n            .done(\n                    function(response) {\n                        VPLUI.webSocketMonitor(response, 'evaluate', 'evaluating', executionActions)\n                        .done(options.next)\n                        .fail(showErrorMessage);\n                    }\n            )\n            .fail(showErrorMessage);\n        };\n        action();\n    }\n    /**\n     * Evaluation for multiple students\n     * @param {object} options {baseurl: Base URL for the evaluation}\n     */\n    function multievaluation(options) {\n        var baseurl = options.baseurl;\n        var goon = true;\n\n        /**\n         * Get grade from result\n         * @param {object} result Result object\n         * @returns {string} Grade\n         */\n        function getGrade(result) {\n            var grade;\n            if (typeof result == 'undefined' || typeof result.grade === 'undefined' || result.grade === null) {\n                grade = '‚õî';\n            } else {\n                grade = 'üëâ ' + result.grade;\n            }\n            return grade;\n        }\n\n         /**\n         * Evaluate a student\n         * @param {number} id Student id\n         * @param {number} subid Submission id\n         */\n        async function evaluateStudent(id, subid) {\n            var ajaxurl = baseurl + id + '&action=';\n            return new Promise(\n                (resolve, reject) => {\n                    var ok = () => {\n                        resolve(true);\n                    };\n                    var cancel = () => {\n                        VPL.updatesublist(subid, getGrade());\n                        goon = false;\n                        reject(false);\n                    };\n                    var action;\n                    var showErrorMessage = function(message) {\n                        VPLUI.showErrorMessage(message, {\n                            closeOnEscape: false,\n                            close: function() {VPL.unhlrow(subid);},\n                            stop: cancel,\n                            next: function() {\n                                VPL.updatesublist(subid, getGrade());\n                                ok();\n                            },\n                        });\n                    };\n                    var executionActions = {\n                        'ajaxurl': ajaxurl,\n                        'run': showErrorMessage,\n                        'setResult': function(result) {\n                            VPL.updatesublist(subid, getGrade(result));\n                        },\n                        'getLastAction': function() {\n                            action();\n                        },\n                    };\n                    action = function() {\n                        VPL.hlrow(subid);\n                        VPLUI.requestAction('evaluate', 'evaluating', {}, ajaxurl)\n                        .done(\n                                function(response) {\n                                    VPLUI.webSocketMonitor(response, 'evaluate', 'evaluating', executionActions)\n                                    .done(ok)\n                                    .fail(showErrorMessage);\n                                }\n                        )\n                        .fail(showErrorMessage);\n                    };\n                    action();\n                }\n            );\n        }\n\n        /**\n         * Evaluate all students\n         */\n        async function evaluateStudents() {\n            var students = VPL.evaluateStudents;\n            var nstudents = students.length;\n            for(var i = 0; i < nstudents; i++) {\n                var student = students[i];\n                if (i === 0) {\n                    VPL.hide_table_rows(student.subid);\n                }\n                var first_td = VPL.get_table_row(student.subid).querySelector('td');\n                first_td.innerHTML = (i + 1) + '/' + nstudents;\n                VPL.show_table_row(student.subid);\n                try {\n                    await evaluateStudent(student.id, student.subid);\n                }\n                catch (e) {\n                    VPL.unhlrow(student.subid);\n                    VPL.updatesublist(student.subid, getGrade());\n                    if (! goon) {\n                        break;\n                    }\n                }\n            }\n        }\n        evaluateStudents();\n    }\n\n    return {\n        init: init,\n        multievaluation: multievaluation,\n    };\n});\n"],"names":["define","VPLUI","init","options","showErrorMessage","message","next","action","window","location","nexturl","executionActions","ajaxurl","run","getLastAction","requestAction","done","response","webSocketMonitor","fail","multievaluation","baseurl","goon","getGrade","result","grade","async","evaluateStudent","id","subid","Promise","resolve","reject","ok","cancel","VPL","updatesublist","closeOnEscape","close","unhlrow","stop","setResult","hlrow","students","evaluateStudents","nstudents","length","i","student","hide_table_rows","get_table_row","querySelector","innerHTML","show_table_row","e"],"mappings":";;;;;;;AAyBAA,mCAAO,CAAC,kBACR,SAASC,OAwJL,MAAO,CACHC,KApJJ,SAAcC,SAWV,SAASC,iBAAiBC,SACtBJ,MAAMG,iBAAiBC,QAAS,CAC5BC,KAAMH,QAAQG,MAEtB,CAEA,IAAIC,OAhBJJ,QAAQG,KAAO,WACXE,OAAOC,SAAWN,QAAQO,SAgB9B,IAAIC,iBAAmB,CACnBC,QAAWT,QAAQS,QACnBC,IAAOT,iBACPU,cAAiB,WACbP,QACJ,IAGJA,OAAS,WACLN,MAAMc,cAAc,WAAY,aAAc,CAAA,EAAIZ,QAAQS,SACzDI,MACO,SAASC,UACLhB,MAAMiB,iBAAiBD,SAAU,WAAY,aAAcN,kBAC1DK,KAAKb,QAAQG,MACba,KAAKf,iBACV,IAEPe,KAAKf,qBAGd,EA+GIgB,gBA1GJ,SAAyBjB,SACrB,IAAIkB,QAAUlB,QAAQkB,QAClBC,MAAO,EAOX,SAASC,SAASC,QAOd,YALqB,IAAVA,aAAiD,IAAjBA,OAAOC,OAA0C,OAAjBD,OAAOC,MACtE,IAEA,MAAQD,OAAOC,KAG/B,CAOAC,eAAeC,gBAAgBC,GAAIC,OAC/B,IAAIjB,QAAUS,QAAUO,GAAK,WAC7B,OAAO,IAAIE,SACP,CAACC,QAASC,UACN,IAQIzB,OARA0B,GAAKA,KACLF,SAAQ,EAAK,EAEbG,OAASA,KACTC,IAAIC,cAAcP,MAAON,YACzBD,MAAO,EACPU,QAAO,EAAM,EAGb5B,iBAAmB,SAASC,SAC5BJ,MAAMG,iBAAiBC,QAAS,CAC5BgC,eAAe,EACfC,MAAO,WAAYH,IAAII,QAAQV,MAAQ,EACvCW,KAAMN,OACN5B,KAAM,WACF6B,IAAIC,cAAcP,MAAON,YACzBU,IACJ,KAGJtB,iBAAmB,CACnBC,QAAWA,QACXC,IAAOT,iBACPqC,UAAa,SAASjB,QAClBW,IAAIC,cAAcP,MAAON,SAASC,QACrC,EACDV,cAAiB,WACbP,QACJ,IAEJA,OAAS,WACL4B,IAAIO,MAAMb,OACV5B,MAAMc,cAAc,WAAY,aAAc,CAAE,EAAEH,SACjDI,MACO,SAASC,UACLhB,MAAMiB,iBAAiBD,SAAU,WAAY,aAAcN,kBAC1DK,KAAKiB,IACLd,KAAKf,iBACV,IAEPe,KAAKf,qBAEF,GAGpB,EAKAsB,iBAGI,IAFA,IAAIiB,SAAWR,IAAIS,iBACfC,UAAYF,SAASG,OACjBC,EAAI,EAAGA,EAAIF,UAAWE,IAAK,CAC/B,IAAIC,QAAUL,SAASI,GACb,IAANA,GACAZ,IAAIc,gBAAgBD,QAAQnB,OAEjBM,IAAIe,cAAcF,QAAQnB,OAAOsB,cAAc,MACrDC,UAAaL,EAAI,EAAK,IAAMF,UACrCV,IAAIkB,eAAeL,QAAQnB,OAC3B,UACUF,gBAAgBqB,QAAQpB,GAAIoB,QAAQnB,MAC7C,CACD,MAAOyB,GAGH,GAFAnB,IAAII,QAAQS,QAAQnB,OACpBM,IAAIC,cAAcY,QAAQnB,MAAON,aAC3BD,KACF,KAER,CACJ,CACJ,CACAsB,EACJ,EAMJ"}